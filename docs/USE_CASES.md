# Finance Manager - Анализ Вариантов Использования (Use Cases)

## Действующие лица (Actors)
1.  **Неавторизованный пользователь (Гость)**: Пользователь, который не вошел в систему. Может только просматривать страницы входа и регистрации.
2.  **Авторизованный пользователь (Клиент)**: Зарегистрированный пользователь, успешно вошедший в систему. Является основным действующим лицом для всех ключевых функций приложения.

## Сценарии Использования

### UC1: Регистрация нового пользователя

*   **Действующее лицо:** Неавторизованный пользователь (Гость)
*   **Предусловие:** Пользователь не авторизован и находится на стартовой странице приложения.
*   **Поток событий:**
    1.  Пользователь нажимает на ссылку "Зарегистрироваться".
    2.  Frontend-приложение (Angular) отображает **форму регистрации нового пользователя** с полями: `Имя пользователя`, `Email`, `Пароль`, `Подтверждение пароля` (согласно мокапу `registration_screen.png`).
    3.  Пользователь заполняет поля формы и нажимает кнопку "Зарегистрироваться".
    4.  Frontend выполняет базовую клиентскую валидацию (например, формат email, совпадение паролей).
    5.  Frontend отправляет `POST` запрос на эндпоинт `/api/auth/register` с данными из формы.
    6.  Backend-сервис (Spring Boot) получает запрос:
        a. Проверяет, что `username` и `email` уникальны, путем запроса к базе данных PostgreSQL.
        b. Хэширует пароль, используя надежный алгоритм (например, BCrypt).
        c. Сохраняет новую запись о пользователе в таблицу `clients`.
    7.  В случае успеха сервис возвращает статус `201 Created`.
    8.  Frontend получает успешный ответ, отображает сообщение об успехе и перенаправляет пользователя на страницу входа.
*   **Альтернативный поток (А):** Валидация не пройдена (например, имя пользователя уже занято).
    *   6a. Сервис возвращает ошибку `4xx` (например, `409 Conflict` для существующего пользователя или `400 Bad Request` для некорректных данных) с описательным сообщением.
    *   6b. Frontend отображает сообщение об ошибке пользователю без перенаправления.
*   **Постусловие:** В системе создана новая учетная запись пользователя.

### UC2: Вход в систему (Аутентификация)

*   **Действующее лицо:** Неавторизованный пользователь (Гость)
*   **Предусловие:** Пользователь находится на странице входа.
*   **Поток событий:**
    1.  Пользователь вводит свои `Имя пользователя` и `Пароль`, затем нажимает "Войти".
    2.  Frontend отправляет `POST` запрос на эндпоинт `/api/auth/login` с учетными данными.
    3.  Backend-сервис получает запрос:
        a. Находит пользователя по `username` в таблице `clients`.
        b. Сравнивает хэш введенного пароля с сохраненным в базе данных.
    4.  Если учетные данные верны, сервис генерирует JWT (JSON Web Token), содержащий идентификатор пользователя (`clientId`).
    5.  Сервис возвращает ответ `200 OK`, в теле которого содержится сгенерированный токен.
    6.  Frontend получает токен, сохраняет его (например, в `localStorage`) и перенаправляет пользователя на главную страницу приложения (Dashboard).
*   **Альтернативный поток (А):** Неверные учетные данные.
    *   4a. Сервис возвращает статус `401 Unauthorized`.
    *   4b. Frontend отображает общее сообщение "Неверное имя пользователя или пароль".
*   **Постусловие:** Пользователь аутентифицирован, в клиенте сохранен активный токен сессии.

### UC3: Создание нового бюджета

*   **Действующее лицо:** Авторизованный пользователь (Клиент)
*   **Предусловие:** Пользователь авторизован и находится в системе. В системе существует хотя бы одна категория.
*   **Поток событий:**
    1.  Пользователь нажимает кнопку "Создать бюджет".
    2.  Frontend отображает форму для создания бюджета с полями: `Лимит` (`limitation`), `Категория` (`category_id`), `Период` (`period`), и, возможно, опцией пригласить других пользователей (для совместного бюджета).
    3.  Пользователь заполняет форму и подтверждает создание.
    4.  Frontend отправляет `POST` запрос на эндпоинт `/api/budgets`. В заголовке `Authorization` передается JWT пользователя (`Bearer <token>`).
    5.  Backend-сервис получает запрос:
        a. Валидирует JWT.
        b. Проверяет корректность входных данных (например, что лимит - положительное число).
        c. Создает новую запись в таблице `budgets`, связывая ее с выбранной категорией.
        d. Создает запись в связующей таблице `client_budgets`, чтобы привязать создателя к новому бюджету.
    6.  Сервис возвращает статус `201 Created` с данными созданного бюджета.
    7.  Frontend получает ответ и обновляет интерфейс, отображая новый бюджет в списке.
*   **Альтернативный поток (А):** Некорректные данные.
    *   5b. Сервис возвращает ошибку `400 Bad Request`.
    *   5c. Frontend отображает ошибку валидации рядом с соответствующими полями формы.
*   **Постусловие:** В базе данных созданы новые записи в таблицах `budgets` и `client_budgets`.

### UC4: Добавление новой транзакции

*   **Действующее лицо:** Авторизованный пользователь (Клиент)
*   **Предусловие:** Пользователь авторизован. У него есть хотя бы один `Счет` (`Account`) и одна `Категория` (`Category`).
*   **Поток событий:**
    1.  Пользователь нажимает кнопку "Добавить транзакцию".
    2.  Frontend отображает форму с полями: `Сумма` (`amount`), `Описание` (`description`), `Счет` (`account_id`), `Категория` (`category_id`), `Дата` (`date`).
    3.  Пользователь заполняет форму и отправляет ее.
    4.  Frontend отправляет `POST` запрос на эндпоинт `/api/transactions`. JWT передается в заголовке `Authorization`.
    5.  Backend-сервис получает запрос:
        a. Валидирует JWT и извлекает `clientId`.
        b. Проверяет, что указанный `account_id` принадлежит текущему пользователю, чтобы предотвратить запись транзакций на чужие счета.
        c. Создает новую запись в таблице `transactions`.
        d. **(Ключевая бизнес-логика)** Обновляет поле `balance` в связанной таблице `accounts`.
        e. **(Ключевая бизнес-логика)** Если транзакция является расходом и попадает под действие активного бюджета, обновляет поле `availableSum` в таблице `budgets`.
    6.  Сервис возвращает статус `201 Created` с данными созданной транзакции.
    7.  Frontend обновляет список транзакций и, возможно, виджеты на главной панели (например, баланс счета).
*   **Альтернативный поток (А):** Пользователь пытается использовать чужой счет.
    *   5b. Сервис возвращает ошибку `403 Forbidden` или `404 Not Found`.
    *   5c. Frontend отображает общую ошибку "Произошла ошибка при добавлении транзакции".
*   **Постусловие:** Новая транзакция добавлена в систему; баланс соответствующего счета и доступная сумма в бюджете обновлены.